
{% extends "base.html" %}

{% block title %}Sécurité du compte - InvestCrypto Pro{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Sécurité du compte</h1>
        <p class="text-gray-600">Gérez la sécurité de votre compte et vos sessions actives</p>
    </div>

    <!-- Statut de sécurité -->
    <div class="professional-card mb-8">
        <h2 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-shield-alt text-blue-500 mr-3"></i>
            Statut de sécurité
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">2FA</span>
                    {% if totp_enabled %}
                        <span class="status-badge status-active">Activé</span>
                    {% else %}
                        <span class="status-badge status-pending">Désactivé</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">Email</span>
                    {% if user.email_verified %}
                        <span class="status-badge status-active">Vérifié</span>
                    {% else %}
                        <span class="status-badge status-pending">Non vérifié</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">Compte</span>
                    {% if user.account_locked %}
                        <span class="status-badge" style="background: #fef2f2; color: #991b1b;">Verrouillé</span>
                    {% else %}
                        <span class="status-badge status-active">Actif</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">Sessions</span>
                    <span class="status-badge status-completed">{{ active_sessions|length }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentification à deux facteurs -->
    <div class="professional-card mb-8">
        <h2 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-mobile-alt text-green-500 mr-3"></i>
            Authentification à deux facteurs (2FA)
        </h2>
        
        {% if not totp_enabled %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i>
                    <div>
                        <p class="font-medium text-yellow-800">2FA non activé</p>
                        <p class="text-yellow-700 text-sm">Activez 2FA pour sécuriser davantage votre compte</p>
                    </div>
                </div>
            </div>
            
            <button onclick="setup2FA()" class="btn-success">
                <i class="fas fa-lock mr-2"></i>
                Activer 2FA
            </button>
        {% else %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-3"></i>
                    <div>
                        <p class="font-medium text-green-800">2FA activé</p>
                        <p class="text-green-700 text-sm">Votre compte est protégé par l'authentification à deux facteurs</p>
                    </div>
                </div>
            </div>
            
            <button onclick="disable2FA()" class="btn-secondary">
                <i class="fas fa-unlock mr-2"></i>
                Désactiver 2FA
            </button>
        {% endif %}
    </div>

    <!-- Changer le mot de passe -->
    <div class="professional-card mb-8">
        <h2 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-key text-blue-500 mr-3"></i>
            Changer le mot de passe
        </h2>
        
        <form id="passwordForm" class="max-w-md">
            <div class="form-group">
                <label class="form-label">Mot de passe actuel</label>
                <input type="password" id="currentPassword" class="professional-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Nouveau mot de passe</label>
                <input type="password" id="newPassword" class="professional-input" required>
                <div class="form-help">Au moins 8 caractères avec majuscules, minuscules, chiffres et caractères spéciaux</div>
            </div>
            
            <button type="submit" class="btn-primary">
                <i class="fas fa-save mr-2"></i>
                Changer le mot de passe
            </button>
        </form>
    </div>

    <!-- Sessions actives -->
    <div class="professional-card mb-8">
        <h2 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-laptop text-purple-500 mr-3"></i>
            Sessions actives
        </h2>
        
        {% if active_sessions %}
            <div class="space-y-4">
                {% for session in active_sessions %}
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">{{ session.ip_address }}</div>
                            <div class="text-sm text-gray-600">{{ session.user_agent[:60] }}...</div>
                            <div class="text-xs text-gray-500 mt-1">
                                Dernière activité: {{ session.last_activity.strftime('%d/%m/%Y %H:%M') if session.last_activity else 'N/A' }}
                            </div>
                        </div>
                        {% if session.ip_address != request.remote_addr %}
                        <button onclick="revokeSession('{{ session.ip_address }}')" class="btn-secondary btn-sm">
                            <i class="fas fa-times mr-1"></i>
                            Révoquer
                        </button>
                        {% else %}
                        <span class="status-badge status-active">Session actuelle</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-600">Aucune session active</p>
        {% endif %}
    </div>

    <!-- Historique des connexions -->
    <div class="professional-card">
        <h2 class="text-xl font-bold mb-6 flex items-center">
            <i class="fas fa-history text-gray-500 mr-3"></i>
            Historique des connexions
        </h2>
        
        {% if login_attempts %}
            <div class="space-y-2">
                {% for attempt in login_attempts %}
                <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                    <div class="flex items-center">
                        {% if attempt.success %}
                            <i class="fas fa-check-circle text-green-500 mr-3"></i>
                            <span class="text-green-600 font-medium">Connexion réussie</span>
                        {% else %}
                            <i class="fas fa-times-circle text-red-500 mr-3"></i>
                            <span class="text-red-600 font-medium">Tentative échouée</span>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">{{ attempt.ip_address }}</div>
                        <div class="text-xs text-gray-500">{{ attempt.attempt_time.strftime('%d/%m/%Y %H:%M') if attempt.attempt_time else 'N/A' }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-600">Aucun historique disponible</p>
        {% endif %}
    </div>
</div>

<!-- Modal 2FA -->
<div id="twoFAModal" class="professional-modal hidden">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Configuration 2FA</h3>
            <button onclick="close2FAModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        
        <div id="qrCodeStep" class="hidden">
            <p class="mb-4">Scannez ce QR code avec votre application d'authentification (Google Authenticator, Authy, etc.)</p>
            <div class="text-center mb-6">
                <img id="qrCodeImage" src="" alt="QR Code 2FA" class="mx-auto border rounded-lg">
            </div>
            <div class="mb-4">
                <label class="form-label">Code secret (si vous ne pouvez pas scanner)</label>
                <input type="text" id="secretKey" class="professional-input" readonly>
            </div>
            <div class="mb-6">
                <label class="form-label">Entrez le code de votre application</label>
                <input type="text" id="totpCode" class="professional-input" placeholder="123456" maxlength="6">
            </div>
            <div class="flex gap-3">
                <button onclick="verify2FA()" class="btn-primary flex-1">
                    <i class="fas fa-check mr-2"></i>
                    Vérifier et activer
                </button>
                <button onclick="close2FAModal()" class="btn-secondary">Annuler</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Désactiver 2FA -->
<div id="disable2FAModal" class="professional-modal hidden">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Désactiver 2FA</h3>
            <button onclick="closeDisable2FAModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                <div>
                    <p class="font-medium text-red-800">Attention !</p>
                    <p class="text-red-700 text-sm">Désactiver 2FA réduira la sécurité de votre compte</p>
                </div>
            </div>
        </div>
        
        <div class="mb-6">
            <label class="form-label">Confirmez avec votre mot de passe</label>
            <input type="password" id="passwordConfirm" class="professional-input" placeholder="Votre mot de passe">
        </div>
        
        <div class="flex gap-3">
            <button onclick="confirmDisable2FA()" class="btn-primary bg-red-500 hover:bg-red-600">
                <i class="fas fa-unlock mr-2"></i>
                Désactiver 2FA
            </button>
            <button onclick="closeDisable2FAModal()" class="btn-secondary">Annuler</button>
        </div>
    </div>
</div>

<script>
// Configuration 2FA
async function setup2FA() {
    try {
        const response = await fetch('/enable-2fa', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('qrCodeImage').src = 'data:image/png;base64,' + data.qr_code;
            document.getElementById('secretKey').value = data.secret;
            document.getElementById('qrCodeStep').classList.remove('hidden');
            document.getElementById('twoFAModal').classList.remove('hidden');
        } else {
            showNotification(data.error || 'Erreur lors de la configuration 2FA', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
}

async function verify2FA() {
    const token = document.getElementById('totpCode').value;
    
    if (!token || token.length !== 6) {
        showNotification('Veuillez entrer un code à 6 chiffres', 'error');
        return;
    }
    
    try {
        const response = await fetch('/verify-2fa', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            close2FAModal();
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.error || 'Code invalide', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
}

function close2FAModal() {
    document.getElementById('twoFAModal').classList.add('hidden');
    document.getElementById('qrCodeStep').classList.add('hidden');
    document.getElementById('totpCode').value = '';
}

// Désactiver 2FA
function disable2FA() {
    document.getElementById('disable2FAModal').classList.remove('hidden');
}

async function confirmDisable2FA() {
    const password = document.getElementById('passwordConfirm').value;
    
    if (!password) {
        showNotification('Mot de passe requis', 'error');
        return;
    }
    
    try {
        const response = await fetch('/disable-2fa', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            closeDisable2FAModal();
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.error || 'Erreur', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
}

function closeDisable2FAModal() {
    document.getElementById('disable2FAModal').classList.add('hidden');
    document.getElementById('passwordConfirm').value = '';
}

// Changer mot de passe
document.getElementById('passwordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    
    if (!currentPassword || !newPassword) {
        showNotification('Tous les champs sont requis', 'error');
        return;
    }
    
    try {
        const response = await fetch('/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            this.reset();
        } else {
            showNotification(data.error || 'Erreur', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
});

// Révoquer session
async function revokeSession(ipAddress) {
    if (!confirm('Êtes-vous sûr de vouloir révoquer cette session ?')) {
        return;
    }
    
    try {
        const response = await fetch('/revoke-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ip_address: ipAddress })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.error || 'Erreur', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
}
</script>
{% endblock %}
