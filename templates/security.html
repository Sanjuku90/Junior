
{% extends "base.html" %}

{% block title %}Param√®tres de S√©curit√©{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Page Header -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">üîê Param√®tres de S√©curit√©</h1>
        <p class="text-gray-600">G√©rez la s√©curit√© de votre compte et consultez votre historique de s√©curit√©.</p>
    </div>

    <!-- Password Change Section -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4">üîë Changer le Mot de Passe</h2>
        <form id="changePasswordForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe actuel</label>
                <input type="password" id="currentPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nouveau mot de passe</label>
                <input type="password" id="newPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Confirmer le nouveau mot de passe</label>
                <input type="password" id="confirmPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md font-medium">
                Changer le Mot de Passe
            </button>
        </form>
    </div>

    <!-- 2FA Section -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4">üõ°Ô∏è Authentification √† Deux Facteurs (2FA)</h2>
        
        {% if user.two_fa_enabled %}
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                <span class="font-semibold text-green-800">2FA Activ√©</span>
            </div>
            <p class="text-sm text-green-700 mt-1">Votre compte est prot√©g√© par l'authentification √† deux facteurs.</p>
        </div>
        
        <form id="disable2FAForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe pour d√©sactiver 2FA</label>
                <input type="password" id="disable2FAPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-md font-medium">
                D√©sactiver 2FA
            </button>
        </form>
        {% else %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                <span class="font-semibold text-yellow-800">2FA D√©sactiv√©</span>
            </div>
            <p class="text-sm text-yellow-700 mt-1">Activez l'authentification √† deux facteurs pour renforcer la s√©curit√©.</p>
        </div>
        
        <button id="enable2FABtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md font-medium">
            Activer 2FA
        </button>
        {% endif %}
    </div>

    <!-- Security Logs -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Historique de S√©curit√©</h2>
        {% if security_logs %}
        <div class="space-y-3">
            {% for log in security_logs %}
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <div class="font-medium text-gray-900">{{ log.action.replace('_', ' ').title() }}</div>
                    <div class="text-sm text-gray-600">{{ log.details }}</div>
                    {% if log.ip_address %}
                    <div class="text-xs text-gray-500">IP: {{ log.ip_address }}</div>
                    {% endif %}
                </div>
                <div class="text-sm text-gray-500">
                    {{ log.created_at[:19].replace('T', ' ') if log.created_at else 'N/A' }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-600">Aucun √©v√©nement de s√©curit√© enregistr√©.</p>
        {% endif %}
    </div>

    <!-- Security Tips -->
    <div class="bg-blue-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-3">Conseils de S√©curit√©</h3>
        <ul class="space-y-2 text-sm text-blue-800">
            <li class="flex items-start">
                <i class="fas fa-check text-blue-600 mr-2 mt-1"></i>
                Utilisez un mot de passe unique et complexe
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-blue-600 mr-2 mt-1"></i>
                Activez l'authentification √† deux facteurs
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-blue-600 mr-2 mt-1"></i>
                Ne partagez jamais vos informations de connexion
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-blue-600 mr-2 mt-1"></i>
                V√©rifiez r√©guli√®rement votre historique de s√©curit√©
            </li>
        </ul>
    </div>
</div>

<!-- 2FA Setup Modal -->
<div id="setup2FAModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full m-4">
        <h3 class="text-lg font-semibold mb-4">Configuration 2FA</h3>
        <div id="setup2FAContent">
            <!-- Content will be populated dynamically -->
        </div>
    </div>
</div>

<script>
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        alert('Les nouveaux mots de passe ne correspondent pas');
        return;
    }
    
    try {
        const response = await fetch('/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword,
                confirm_password: confirmPassword
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Mot de passe chang√© avec succ√®s');
            this.reset();
        } else {
            alert(data.error || 'Erreur lors du changement de mot de passe');
        }
    } catch (error) {
        alert('Erreur de connexion');
    }
});

document.getElementById('enable2FABtn')?.addEventListener('click', async function() {
    try {
        const response = await fetch('/enable-2fa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('setup2FAContent').innerHTML = `
                <div class="text-center mb-4">
                    <img src="${data.qr_code}" alt="QR Code 2FA" class="mx-auto mb-4">
                    <p class="text-sm text-gray-600 mb-2">Scannez ce QR code avec votre app d'authentification</p>
                    <p class="text-xs text-gray-500">Cl√© manuelle: ${data.secret}</p>
                </div>
                <form id="verify2FAForm">
                    <input type="text" id="verification2FACode" placeholder="Code de v√©rification" class="w-full px-3 py-2 border border-gray-300 rounded-md mb-4">
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-md">V√©rifier et Activer</button>
                </form>
                <button onclick="document.getElementById('setup2FAModal').classList.add('hidden')" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-md mt-2">Annuler</button>
            `;
            document.getElementById('setup2FAModal').classList.remove('hidden');
        } else {
            alert(data.error || 'Erreur lors de l\'activation 2FA');
        }
    } catch (error) {
        alert('Erreur de connexion');
    }
});

document.getElementById('disable2FAForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const password = document.getElementById('disable2FAPassword').value;
    
    try {
        const response = await fetch('/disable-2fa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                password: password
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('2FA d√©sactiv√© avec succ√®s');
            location.reload();
        } else {
            alert(data.error || 'Erreur lors de la d√©sactivation 2FA');
        }
    } catch (error) {
        alert('Erreur de connexion');
    }
});

// Handle 2FA verification form dynamically
document.addEventListener('submit', async function(e) {
    if (e.target.id === 'verify2FAForm') {
        e.preventDefault();
        
        const code = document.getElementById('verification2FACode').value;
        
        try {
            const response = await fetch('/verify-2fa', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: code
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('2FA activ√© avec succ√®s');
                location.reload();
            } else {
                alert(data.error || 'Code de v√©rification invalide');
            }
        } catch (error) {
            alert('Erreur de connexion');
        }
    }
});
</script>
{% endblock %}
