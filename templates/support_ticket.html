
{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="messenger-card">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    ðŸŽ« Ticket #{{ ticket.id }} - {{ ticket.subject }}
                </h1>
                <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600">
                    <span><i class="fas fa-tag mr-1"></i>{{ ticket.category.title() }}</span>
                    <span><i class="fas fa-calendar mr-1"></i>{{ ticket.created_at[:10] }}</span>
                    <span class="status-indicator 
                        {% if ticket.status == 'open' %}status-pending{% endif %}
                        {% if ticket.status == 'admin_reply' %}status-active{% endif %}
                        {% if ticket.status == 'user_reply' %}bg-blue-100 text-blue-800{% endif %}
                        {% if ticket.status == 'closed' %}status-completed{% endif %}">
                        {{ ticket.status.replace('_', ' ').title() }}
                    </span>
                </div>
            </div>
            <a href="{{ url_for('support') }}" class="messenger-btn-outline">
                <i class="fas fa-arrow-left mr-2"></i>Retour
            </a>
        </div>
    </div>

    <!-- Messages -->
    <div class="messenger-card">
        <h2 class="text-lg font-semibold mb-4">ðŸ’¬ Conversation</h2>
        
        <div id="messagesContainer" class="space-y-4 max-h-96 overflow-y-auto">
            {% for message in messages %}
                <div class="{% if message.is_admin %}flex{% else %}flex justify-end{% endif %}">
                    <div class="max-w-md {% if message.is_admin %}bg-gray-100{% else %}bg-blue-500 text-white{% endif %} rounded-lg p-4">
                        <div class="text-xs {% if message.is_admin %}text-gray-600{% else %}text-blue-100{% endif %} mb-1">
                            {% if message.is_admin %}
                                ðŸ’¼ Support
                            {% else %}
                                ðŸ‘¤ {{ message.first_name }} {{ message.last_name }}
                            {% endif %}
                            â€¢ {{ message.created_at[:16] }}
                        </div>
                        <div class="text-sm">{{ message.message }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        {% if ticket.status != 'closed' %}
            <!-- Reply Form -->
            <div class="mt-6 pt-4 border-t border-gray-200">
                <form id="replyForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Votre rÃ©ponse</label>
                        <textarea id="replyMessage" class="messenger-input h-24" placeholder="Tapez votre message..." required></textarea>
                    </div>
                    <button type="submit" class="messenger-btn">
                        <i class="fas fa-paper-plane mr-2"></i>Envoyer la rÃ©ponse
                    </button>
                </form>
            </div>
        {% else %}
            <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                <div class="bg-gray-100 rounded-lg p-4">
                    <i class="fas fa-lock text-gray-400 text-xl mb-2"></i>
                    <p class="text-gray-600">Ce ticket a Ã©tÃ© fermÃ©. Vous ne pouvez plus y rÃ©pondre.</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Handle reply form
document.getElementById('replyForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const message = document.getElementById('replyMessage').value.trim();
    if (!message) return;
    
    try {
        const response = await fetch('/support/send-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ticket_id: {{ ticket.id }},
                message: message
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Add message to UI
            const messagesContainer = document.getElementById('messagesContainer');
            const newMessage = document.createElement('div');
            newMessage.className = 'flex justify-end';
            newMessage.innerHTML = `
                <div class="max-w-md bg-blue-500 text-white rounded-lg p-4">
                    <div class="text-xs text-blue-100 mb-1">
                        ðŸ‘¤ {{ ticket.first_name }} {{ ticket.last_name }}
                        â€¢ Ã€ l'instant
                    </div>
                    <div class="text-sm">${message}</div>
                </div>
            `;
            messagesContainer.appendChild(newMessage);
            
            // Clear form and scroll
            document.getElementById('replyMessage').value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            showNotification('RÃ©ponse envoyÃ©e!', 'success');
        } else {
            showNotification(result.error || 'Erreur lors de l\'envoi', 'error');
        }
    } catch (error) {
        showNotification('Erreur de connexion', 'error');
    }
});

// Auto-refresh messages every 30 seconds
setInterval(async () => {
    try {
        const response = await fetch('/support/get-messages/{{ ticket.id }}');
        const result = await response.json();
        
        if (result.messages) {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            result.messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = message.is_admin ? 'flex' : 'flex justify-end';
                messageDiv.innerHTML = `
                    <div class="max-w-md ${message.is_admin ? 'bg-gray-100' : 'bg-blue-500 text-white'} rounded-lg p-4">
                        <div class="text-xs ${message.is_admin ? 'text-gray-600' : 'text-blue-100'} mb-1">
                            ${message.is_admin ? 'ðŸ’¼ Support' : 'ðŸ‘¤ ' + message.sender_name}
                            â€¢ ${message.created_at.substring(0, 16)}
                        </div>
                        <div class="text-sm">${message.message}</div>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    } catch (error) {
        console.log('Erreur lors du rafraÃ®chissement des messages');
    }
}, 30000);
</script>
{% endblock %}
